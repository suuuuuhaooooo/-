<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è˜‡æ˜Šé›²ç«¯æ•™å®¤ï½œå­¸ç”Ÿå°ˆå€</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        :root { --primary: #8e9775; --secondary: #a2aab0; --bg: #f4f4f2; }
        body { font-family: "Noto Serif TC", serif; background-color: var(--bg); margin: 0; color: #444; }

        /* ç™»å…¥ä»‹é¢ */
        #login-ui { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-card { background: white; padding: 50px 40px; border-radius: 2px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); width: 100%; max-width: 350px; text-align: center; border-top: 5px solid var(--primary); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #eee; background: #f9f9f9; box-sizing: border-box; }
        .main-btn { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; cursor: pointer; letter-spacing: 2px; transition: 0.3s; }

        /* æ•™å®¤ä¸»ä»‹é¢ (å·¦å³ä½ˆå±€) */
        #classroom-ui { display: none; max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .classroom-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid var(--secondary); margin-bottom: 20px; }
        
        .main-layout { display: flex; gap: 30px; align-items: flex-start; }
        
        /* å·¦å´ï¼šå½±ç‰‡æ’­æ”¾å€ */
        .video-column { flex: 2.5; background: white; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.02); }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .current-info { margin-top: 15px; }
        .current-title { font-size: 1.2em; font-weight: 700; color: var(--primary); }

        /* å³å´ï¼šæ¸…å–®å€ */
        .list-column { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 300px; }
        .list-card { background: white; padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.02); border-radius: 2px; }
        .list-header { font-weight: 700; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; color: var(--primary); font-size: 0.95em; letter-spacing: 1px; }
        
        /* é¸å–®èˆ‡æ•™ææ¸…å–®é …ç›® */
        .nav-item { display: block; padding: 12px; text-decoration: none; color: #666; font-size: 0.9em; border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: 0.2s; }
        .nav-item:hover { background: #fafafa; color: var(--primary); }
        .nav-item.active { border-left: 4px solid var(--primary); background: #f7faf7; font-weight: 700; color: var(--primary); }

        .logout-link { font-size: 12px; color: #999; cursor: pointer; text-decoration: underline; }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 900px) {
            .main-layout { flex-direction: column; }
            .video-column, .list-column { flex: none; width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>

    <div id="login-ui">
        <div class="login-card">
            <h1 style="font-size: 24px; letter-spacing: 4px;">å­¸ç”Ÿç™»å…¥</h1>
            <input type="email" id="email" placeholder="å­¸ç¿’å¸³è™Ÿ">
            <input type="password" id="password" placeholder="å¯†ç¢¼">
            <button class="main-btn" onclick="login()">é€²å…¥æ•™å®¤</button>
            <p id="error-msg" style="color:#b03a2e; font-size:12px; margin-top:10px"></p>
        </div>
    </div>

    <div id="classroom-ui">
        <div class="classroom-header">
            <div>
                <h2 id="welcome-text" style="margin:0; font-size: 18px;">è¼‰å…¥ä¸­...</h2>
                <span class="logout-link" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</span>
            </div>
            <div style="font-size: 12px; color: var(--primary); font-weight: bold;">è˜‡æ˜Šæ•¸ç†é›²ç«¯ç³»çµ±</div>
        </div>

        <div class="main-layout">
            <div class="video-column">
                <div class="video-wrapper">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 60px; z-index: 10; cursor: default;"></div>
                    <iframe id="main-video" src="" frameborder="0" allowfullscreen></iframe>
                </div>
                <div class="current-info">
                    <div id="display-title" class="current-title">è«‹é¸æ“‡èª²ç¨‹å–®å…ƒ</div>
                </div>
            </div>

            <div class="list-column">
                <div class="list-card">
                    <div class="list-header">ğŸ“½ï¸ èª²ç¨‹å½±éŸ³æ¸…å–®</div>
                    <div id="video-nav-list">
                        <p style="font-size: 12px; color: #999;">æ­£åœ¨åŒæ­¥å½±ç‰‡...</p>
                    </div>
                </div>

                <div class="list-card">
                    <div class="list-header">ğŸ“– æ•™æè³‡æºä¸‹è¼‰</div>
                    <div id="pdf-resource-list">
                        <p style="font-size: 12px; color: #999;">æ­£åœ¨åŒæ­¥æ•™æ...</p>
                    </div>
                </div>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 60px; color: #bbb; font-size: 11px;">
            <p>Â© 2026 è˜‡æ˜Šæ•¸ç†æ•™å­¸ç³»çµ±ï½œå°ˆæ¥­æ•™æèˆ‡å½±éŸ³è§£é¡Œ</p>
        </footer>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyALkTnkYY3JZLCTyajahpi4IZKmFX9USdw",
            authDomain: "su-hao-classroom.firebaseapp.com",
            projectId: "su-hao-classroom",
            storageBucket: "su-hao-classroom.firebasestorage.app",
            messagingSenderId: "764168135846",
            appId: "1:764168135846:web:f2923a5f4952fa1ca64067",
            databaseURL: "https://su-hao-classroom-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx884HoE5YwEpoWwKR3aIIvAUGrydmwRFC7ETpW_UowiSsIoMch9esQye_7WjRQrNQelQ/exec";

        // --- 1. è‡ªå‹•ç™»å‡ºèˆ‡å¤šè£ç½®åµæ¸¬ ---
        let idleTimer;
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            if (auth.currentUser) {
                idleTimer = setTimeout(() => {
                    alert("ç”±æ–¼é•·æ™‚é–“æœªæ“ä½œï¼Œç³»çµ±å·²è‡ªå‹•ç™»å‡ºã€‚");
                    logout();
                }, 900000); // 15åˆ†é˜
            }
        }
        window.onmousemove = window.onkeypress = window.ontouchstart = resetIdleTimer;

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password).then(cred => {
                const newSessionId = Math.random().toString(36).substring(2);
                localStorage.setItem('session_id', newSessionId);
                db.ref('sessions/' + cred.user.uid).set(newSessionId);
            }).catch(() => { document.getElementById('error-msg').innerText = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚"; });
        }

        function logout() { 
            if(auth.currentUser) db.ref('sessions/' + auth.currentUser.uid).remove(); 
            auth.signOut(); 
        }

        // --- 2. å½±ç‰‡åˆ‡æ›åŠŸèƒ½ ---
        function changeVideo(id, title, element) {
            document.getElementById('main-video').src = `https://www.youtube.com/embed/${id}?modestbranding=1&rel=0&disablekb=1`;
            document.getElementById('display-title').innerText = title;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        // --- 3. æ ¸å¿ƒé‚è¼¯ ---
        auth.onAuthStateChanged(user => {
            if (user) {
                db.ref('sessions/' + user.uid).on('value', (snapshot) => {
                    if (snapshot.val() && localStorage.getItem('session_id') && snapshot.val() !== localStorage.getItem('session_id')) {
                        alert("åµæ¸¬åˆ°æ­¤å¸³è™Ÿå·²åœ¨å…¶ä»–è£ç½®ç™»å…¥ã€‚");
                        logout();
                    }
                });

                document.getElementById('login-ui').style.display = 'none';
                document.getElementById('classroom-ui').style.display = 'block';
                resetIdleTimer();

                fetch(SCRIPT_URL).then(res => res.json()).then(allData => {
                    const myData = allData.find(item => item.uid === user.uid);
                    if (myData) {
                        document.getElementById('welcome-text').innerText = `${myData.name} åŒå­¸ï¼Œä½ å¥½`;
                        
                        // è™•ç†å½±ç‰‡æ¸…å–®
                        const ids = myData.idList.split(',').map(id => id.trim()).filter(id => id);
                        document.getElementById('video-nav-list').innerHTML = ids.map((id, index) => `
                            <div class="nav-item" onclick="changeVideo('${id}', '${myData.level}${myData.subject} - å½±éŸ³é‡é» (${index + 1})', this)">
                                ğŸ¬ ç¬¬ ${index + 1} è¬›ï¼šå–®å…ƒæ ¸å¿ƒè§£æ
                            </div>
                        `).join('');

                        // é è¨­åŠ è¼‰ç¬¬ä¸€æ”¯å½±ç‰‡
                        if(ids.length > 0) {
                            const firstItem = document.querySelector('.nav-item');
                            changeVideo(ids[0], `${myData.level}${myData.subject} - å½±éŸ³é‡é» (1)`, firstItem);
                        }

                        // è™•ç†æ•™ææ¸…å–® (æ”¯æ´å¤šå€‹é€£çµ)
                        const docs = myData.doc.split(',').map(url => url.trim()).filter(url => url);
                        document.getElementById('pdf-resource-list').innerHTML = docs.map((url, i) => `
                            <a href="${url}" target="_blank" class="nav-item">ğŸ“„ ä¸‹è¼‰å–®å…ƒ ${i+1} è¬›ç¾©æ•™æ</a>
                        `).join('');
                    }
                });
            } else {
                document.getElementById('login-ui').style.display = 'flex';
                document.getElementById('classroom-ui').style.display = 'none';
            }
        });
    </script>
</body>
</html>
